{% extends 'layout/base.html' %}

{% block title %}Đặt Lịch Khám - {{ doctor.first_name }} {{ doctor.last_name }}{% endblock %}
{% block search_bar %}{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <div class="d-flex align-items-center flex-column text-center">
          <img src="{{ doctor.avatar or url_for('static', filename='images/default_avatar.jpg') }}"
               alt="Doctor Avatar" class="rounded-circle mb-3"
               style="width: 120px; height: 120px; object-fit: cover;">

          <h5>BS. {{ doctor.last_name }} {{ doctor.first_name }}</h5>

          <p class="mb-1 text-muted">
            <i class="fas fa-stethoscope"></i> Chuyên khoa:
            {% if doctor.doctor.doctor_departments %}
            {{ doctor.doctor.doctor_departments | map(attribute='department.name') | join(', ') }}
            {% else %}
            Đang cập nhật
            {% endif %}
          </p>
          <p class="mb-0 text-muted">
            <i class="fas fa-hospital"></i> Nơi công tác:
            {% if doctor.doctor.medical_center %}
            {{ doctor.doctor.medical_center.name }}
            {% else %}
            Đang cập nhật
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <h2 class="mb-4">Đặt Lịch Khám Với Bác Sĩ {{ doctor.first_name }} {{ doctor.last_name }}</h2>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
      {% endif %}
      {% endwith %}

      <div class="card p-4">
        <form method="POST" action="{{ url_for('book_appointment', doctor_id=doctor.id) }}">
          <input type="hidden" name="appointment_date" value="{{ selected_date or '' }}">

          <h4>1. Chọn ngày và khung giờ</h4>

          <div class="date-navigator d-flex align-items-center mb-3">
            <div class="d-flex flex-nowrap overflow-auto flex-grow-1">
              {% if available_dates %}
              {% for day_info in available_dates %}
              {% set day_name = "CN" if day_info.date.weekday() == 6 else "Th " + (day_info.date.weekday() + 2)|string
              %}
              <div
                class="date-item text-center p-2 border rounded mx-1 {% if day_info.is_selected %}bg-primary text-white{% endif %}"
                style="min-width: 120px; cursor: pointer; flex-shrink: 0;"
                onclick="window.location.href = '{{ url_for('book_appointment', doctor_id=doctor.id) }}?appointment_date={{ day_info.date.strftime('%Y-%m-%d') }}'">
                <div class="font-weight-bold">{{ day_name }}</div>
                <div>{{ day_info.date.strftime('%d-%m') }}</div>
                <small>{{ day_info.shift_count }} khung giờ</small>
              </div>
              {% endfor %}
              {% else %}
              <p class="text-muted">Bác sĩ không có lịch làm việc trong 7 ngày tới.</p>
              {% endif %}
            </div>
          </div>

          <div class="form-group mt-3">
            <legend class="col-form-label pt-0">Chọn giờ hẹn:</legend>
            {% if current_date_shifts %}
            {% for session_name, shifts in current_date_shifts.items() %}
            <h5>{{ session_name }}</h5>
            <div class="d-flex flex-wrap">
              {% for ds in shifts %}
              <div class="p-1">
                <input type="radio" class="btn-check" name="doctor_shift_id"
                       id="shift-{{ ds.id }}" value="{{ ds.id }}" autocomplete="off" required>
                <label class="btn btn-outline-primary"
                       for="shift-{{ ds.id }}">{{ ds.shift.start_time.strftime('%H:%M') }}</label>
              </div>
              {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            <p class="text-danger">Vui lòng chọn ngày có lịch làm việc để xem khung giờ.</p>
            {% endif %}
          </div>

          <hr class="my-4">

          <h4>2. Thông tin bệnh nhân</h4>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="first_name">Họ đệm</label>
              <input type="text" class="form-control" id="first_name" name="first_name"
                     value="{{ current_user_info.first_name if current_user_info else '' }}" required>
            </div>
            <div class="form-group col-md-6">
              <label for="last_name">Tên</label>
              <input type="text" class="form-control" id="last_name" name="last_name"
                     value="{{ current_user_info.last_name if current_user_info else '' }}" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="birth_of_day">Ngày sinh</label>
              <input type="date" class="form-control" id="birth_of_day" name="birth_of_day"
                     value="{{ current_user_info.birth_of_day.strftime('%Y-%m-%d') if current_user_info and current_user_info.birth_of_day else '' }}"
                     required>
            </div>
            <div class="form-group col-md-6">
              <label for="gender">Giới tính</label>
              <select class="form-control" id="gender" name="gender" required>
                <option value="">Chọn giới tính</option>
                <option value="Male" {% if current_user_info and current_user_info.gender==
                'Male' %}selected{% endif %}>Nam</option>
                <option value="Female" {% if current_user_info and current_user_info.gender==
                'Female' %}selected{% endif %}>Nữ</option>
                <option value="Other" {% if current_user_info and current_user_info.gender==
                'Other' %}selected{% endif %}>Khác</option>
              </select>
            </div>
          </div>

          <button class="btn btn-primary mt-3" type="submit">Xác nhận đặt lịch</button>
        </form>
      </div>
    </div>
  </div>
  <a href="{{ url_for('home') }}" class="btn btn-secondary mt-3">Quay Lại Trang Chủ</a>
</div>
{% endblock %}